(()=>{if(window.__clickRedirectDetectorActive){console.warn("Detector already active.");return}window.__clickRedirectDetectorActive=!0;const log=(...a)=>console.log("%c[redirect-detector]","color: white; background: #6b5cff; padding: 2px 6px; border-radius:4px;",...a);let last=null;function record(it){last=Object.assign({time:Date.now()},it);window.__ccd_history=window.__ccd_history||[];window.__ccd_history.push(last);if(window.__ccd_history.length>20)window.__ccd_history.shift()}function resolveUrl(u){if(!u) return null;try{return new URL(u,document.baseURI||location.href).href}catch(e){return u}}function findAF(el){let n=el,A=null,F=null;while(n&&1===n.nodeType){if(!A&&n.tagName&&"a"===n.tagName.toLowerCase())A=n; if(!F&&n.tagName&&"form"===n.tagName.toLowerCase())F=n; if(A&&F)break; n=n.parentElement}return{anchor:A,form:F}}function onClick(e){try{const tgt=e.target;const {anchor,form}=findAF(tgt);const info={type:"click",x:e.clientX,y:e.clientY,button:e.button,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey};if(anchor){const raw=anchor.getAttribute("href")||anchor.href||null;info.element=anchor;info.href=resolveUrl(raw);info.rawHref=raw;info.target=anchor.getAttribute("target")||null}else if(form){const rawA=form.getAttribute("action")||form.action||null;info.form=form;info.formAction=resolveUrl(rawA);info.rawFormAction=rawA;info.method=(form.getAttribute("method")||form.method||"GET").toUpperCase()}else info.element=tgt;record(info);log("Interaction recorded:",info.href||info.formAction||info.element)}catch(err){console.error(err)}}function onSubmit(e){try{const f=e.target;const raw=f.getAttribute("action")||f.action||null;const info={type:"formsubmit",form:f,formAction:resolveUrl(raw),rawFormAction:raw,method:(f.getAttribute("method")||f.method||"GET").toUpperCase()};record(info);log("Form submit recorded:",info.formAction)}catch(err){console.error(err)}}const _open=window.open.bind(window);window.open=function(url,target,features){try{const abs=resolveUrl(url);record({type:"open",href:abs,rawHref:url,target});log("window.open ->",abs,"target:",target)}catch(e){console.error(e)}return _open(url,target,features)};const _push=history.pushState.bind(history),_replace=history.replaceState.bind(history);history.pushState=function(state,title,url){try{const abs=resolveUrl(url);record({type:"pushState",href:abs,rawHref:url});log("history.pushState ->",abs)}catch(e){console.error(e)}return _push(state,title,url)};history.replaceState=function(state,title,url){try{const abs=resolveUrl(url);record({type:"replaceState",href:abs,rawHref:url});log("history.replaceState ->",abs)}catch(e){console.error(e)}return _replace(state,title,url)};let lastHref=location.href;const POLL=150,WINDOW_MS=3e3;const poller=setInterval(()=>{try{const cur=location.href;if(cur!==lastHref){const now=Date.now();let assoc=null;last&&now-last.time<=WINDOW_MS&&(assoc=last);log("Detected navigation:",{from:lastHref,to:cur,associatedInteraction:assoc?assoc.type:null});window.__ccd_navs=window.__ccd_navs||[];window.__ccd_navs.push({time:now,from:lastHref,to:cur,associatedInteraction:assoc});if(window.__ccd_navs.length>50)window.__ccd_navs.shift();lastHref=cur}}catch(e){console.error(e)}},POLL);window.addEventListener("beforeunload",e=>{try{const now=Date.now();let assoc=null;last&&now-last.time<=WINDOW_MS&&(assoc=last);log("beforeunload fired. Recent interaction:",assoc||"none");window.__ccd_navs=window.__ccd_navs||[];window.__ccd_navs.push({time:now,event:"beforeunload",associatedInteraction:assoc})}catch(e){console.error(e)}},!0);window.addEventListener("popstate",e=>{try{const now=Date.now();let assoc=null;last&&now-last.time<=WINDOW_MS&&(assoc=last);log("popstate (history back/forward). Associated interaction:",assoc);window.__ccd_navs=window.__ccd_navs||[];window.__ccd_navs.push({time:now,event:"popstate",associatedInteraction:assoc})}catch(e){console.error(e)}});document.addEventListener("click",onClick,!0);document.addEventListener("submit",onSubmit,!0);const mo=new MutationObserver(()=>{});mo.observe(document.documentElement||document.body,{childList:!0,subtree:!0});window.__ccd_getHistory=function(){return{interactions:window.__ccd_history||[],navigations:window.__ccd_navs||[]}};window.__ccd_stop=function(){try{document.removeEventListener("click",onClick,!0);document.removeEventListener("submit",onSubmit,!0);history.pushState=_push;history.replaceState=_replace;window.open=_open;clearInterval(poller);mo.disconnect();window.__clickRedirectDetectorActive=!1;log("Detector stopped and cleaned up.")}catch(e){console.error(e)}};log("Redirect detector active. Paste `__ccd_getHistory()` to inspect, or call `__ccd_stop()` to stop.")})();
